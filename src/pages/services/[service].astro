---
import { postalSystemsLocalBusinessSchema as schema } from "../../schema/localBusiness.ts";
import { getServiceSchema } from "../../schema/service";
import SiteLayout from "../../layouts/SiteLayout.astro"
import Breadcrumbs from "../../components/Breadcrumbs.astro"
import CTA from "../../components/ui/CTA.astro"
import SectionHeader from "../../components/ui/SectionHeader.astro"
import TrustGrid from "../../components/TrustGrid.astro"
import ProcessStrip from "../../components/ProcessStrip.astro"
import { slugify } from "../../lib/slug"

type Service = {
  name: string
  summary?: string
  content?: string
}

export async function getStaticPaths() {
  const services = (await import("../../data/services.json")).default as Service[]

  return services.map((s) => ({
    params: { service: slugify(s.name) },
    props: { service: s },
  }))
}

const { service } = Astro.props as { service: Service }

const serviceSlug = slugify(service.name)

const areas = (await import("../../data/areas.json")).default as {
  city: string
  state?: string
  county?: string
}[]

const primaryAreas = areas.filter((a) => a.county === "San Diego County")
const featuredAreas = (primaryAreas.length ? primaryAreas : areas).slice(0, 6)

const servicesContentModules = import.meta.glob(
  "../../data/services-content/*.json",
  { eager: true }
) as Record<string, any>

const serviceContentMap = Object.fromEntries(
  Object.entries(servicesContentModules).map(([path, mod]) => {
    const slug = path.split("/").pop()?.replace(".json", "") ?? ""
    return [slug, (mod as any).default]
  })
) as Record<string, any>

const serviceContent = serviceContentMap[serviceSlug] ?? null

const heroImage = serviceContent?.heroImage || ""
const heroAlt =
  serviceContent?.heroAlt ||
  `${service.name} installation and mailbox projects in San Diego County`

const title = `${service.name} — Mailbox Services | Postal Systems`
const desc =
  service.summary ||
  `USPS-approved ${service.name.toLowerCase()} for HOAs, apartments, and commercial properties in San Diego County.`
const canonical = `https://sandiegocommercialmailboxes.com/services/${serviceSlug}/`

const serviceSchema = getServiceSchema({
  name: service.name,
  description: desc,
  serviceUrl: canonical,
})

const faqItems = (serviceContent?.faqs ?? []) as { question: string; answer: string }[]

const faqSchema = faqItems.length
  ? {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      mainEntity: faqItems.map((faq) => ({
        "@type": "Question",
        name: faq.question,
        acceptedAnswer: {
          "@type": "Answer",
          text: faq.answer,
        },
      })),
    }
  : null

const pageSchema = faqSchema ? [schema, serviceSchema, faqSchema] : [schema, serviceSchema]

export const prerender = true

---
<SiteLayout {title} description={desc} canonical={canonical} schema={pageSchema}>
  <main class="max-w-6xl mx-auto px-4 lg:px-6 py-10 lg:py-12">
    <Breadcrumbs
      crumbs={[
        { href: "/", label: "Home" },
        { href: "/services/", label: "Services" },
        { href: canonical, label: service.name },
      ]}
    />

    <section class="mt-6 grid gap-8 lg:grid-cols-[minmax(0,1.4fr)_minmax(0,1fr)] items-start">
      <div>
        <p class="text-[11px] font-semibold tracking-[0.2em] uppercase text-ps-navy/70">
          Mailbox services · San Diego County
        </p>
        <h1 class="mt-2 text-3xl md:text-4xl font-semibold tracking-tight text-ps-navy">
          {service.name}
        </h1>
        <p class="mt-3 text-sm md:text-base text-ps-navy/85 max-w-xl">
          {desc}
        </p>
        <ul class="mt-4 space-y-1.5 text-sm text-ps-navy/85">
          <li>• USPS-approved installation and coordination.</li>
          <li>• Pads, anchors, mounting, and ADA-compliant layouts.</li>
          <li>• Tenant notices and USPS inspections managed for you.</li>
          <li>• Ideal for HOAs, apartments, builders, and facilities.</li>
        </ul>
        <div class="mt-6 flex flex-wrap gap-3">
          <a
            href="/contact/"
            class="inline-flex items-center justify-center rounded-full bg-ps-red px-5 py-2.5 text-sm font-semibold text-white shadow-md hover:bg-ps-red/90 transition"
          >
            Get a USPS-approved quote
          </a>
          <a
            href="tel:16194614787"
            class="inline-flex items-center justify-center rounded-full border border-ps-navy/20 bg-white px-5 py-2.5 text-sm font-semibold text-ps-navy hover:bg-ps-navy hover:text-white transition"
          >
            Call (619) 461-4787
          </a>
        </div>
      </div>

      <aside class="rounded-3xl bg-white shadow-ps border border-ps-muted px-5 py-5 md:px-6 md:py-6">
        {heroImage && (
          <div class="mb-4 overflow-hidden rounded-2xl bg-ps-surface">
            <img
              src={heroImage}
              alt={heroAlt}
              loading="lazy"
              decoding="async"
              class="h-44 w-full object-cover md:h-52"
            />
          </div>
        )}
        <h2 class="text-sm font-semibold text-ps-navy">Projects we help with</h2>
        <p class="mt-2 text-xs text-ps-navy/80">
          From new construction to retrofit replacements, Postal Systems designs and installs
          commercial mailbox systems that meet USPS and ADA requirements.
        </p>
        <ul class="mt-3 space-y-1.5 text-xs text-ps-navy/85">
          <li>• New multifamily developments and HOAs.</li>
          <li>• Existing communities needing replacements.</li>
          <li>• Commercial, industrial, and campus properties.</li>
        </ul>
        <div class="mt-5">
          <CTA primaryHref="/contact/" primaryLabel="Request a quote" />
        </div>
      </aside>
    </section>

    {serviceContent?.h2Blocks && serviceContent.h2Blocks.length > 0 && (
      <section class="mt-10 space-y-10 max-w-3xl">
        {serviceContent.h2Blocks.map((block: any, idx: number) => (
          <article id={block.id} class="space-y-3">
            <h2 class="text-xl md:text-2xl font-semibold text-ps-navy">
              {block.heading}
            </h2>
            {block.body && (
              <p class="text-sm md:text-base text-ps-navy/85">
                {block.body}
              </p>
            )}
            {block.bullets && block.bullets.length > 0 && (
              <ul class="mt-2 space-y-1.5 text-sm text-ps-navy/85">
                {block.bullets.map((item: string) => (
                  <li class="flex gap-2">
                    <span class="mt-1 h-1.5 w-1.5 rounded-full bg-ps-red"></span>
                    <span>{item}</span>
                  </li>
                ))}
              </ul>
            )}
            {block.steps && block.steps.length > 0 && (
              <div class="mt-4 grid gap-3 md:grid-cols-2">
                {block.steps.map((step: any, stepIndex: number) => (
                  <div class="rounded-2xl border border-ps-muted bg-white p-4 shadow-ps">
                    <div class="text-[11px] font-semibold uppercase tracking-[0.18em] text-ps-navy/60">
                      STEP {stepIndex + 1}
                    </div>
                    <div class="mt-1 text-sm font-semibold text-ps-navy">
                      {step.title}
                    </div>
                    <p class="mt-1 text-xs text-ps-navy/80">
                      {step.detail}
                    </p>
                  </div>
                ))}
              </div>
            )}
            {block.closing && (
              <p class="mt-2 text-sm md:text-base text-ps-navy/85">
                {block.closing}
              </p>
            )}
          </article>
        ))}
      </section>
    )}

    {!serviceContent?.h2Blocks &&
      service.content && (
        <section class="mt-10">
          <SectionHeader
            title={`Details about our ${service.name.toLowerCase()}`}
            subtitle="From layout and foundations to USPS approvals."
            align="left"
          />
          <div
            class="prose max-w-none mt-4 text-ps-navy/90"
            set:html={service.content}
          ></div>
        </section>
      )}

    {serviceContent?.faqs && serviceContent.faqs.length > 0 && (
      <section class="mt-10">
        <SectionHeader
          title={`FAQs about ${service.name.toLowerCase()} in San Diego County`}
          subtitle="Answers to common questions from HOAs, property managers, and builders."
          align="left"
        />
        <div class="mt-4 space-y-3">
          {serviceContent.faqs.map((faq: any) => (
            <details class="group rounded-2xl border border-ps-muted bg-white p-4 shadow-ps">
              <summary class="flex cursor-pointer items-center justify-between text-sm font-semibold text-ps-navy">
                <span>{faq.question}</span>
                <span class="ml-3 text-xs text-ps-navy/60 group-open:hidden">+</span>
                <span class="ml-3 text-xs text-ps-navy/60 hidden group-open:inline">−</span>
              </summary>
              <p class="mt-2 text-xs text-ps-navy/80">
                {faq.answer}
              </p>
            </details>
          ))}
        </div>
      </section>
    )}

    <section class="mt-10">
      <SectionHeader
        title={`Where we provide ${service.name.toLowerCase()}`}
        subtitle="Serving San Diego County first, with select nearby markets."
        align="left"
      />
      <ul class="mt-4 grid gap-4 md:grid-cols-3 text-sm">
        {featuredAreas.map((a) => {
          const citySlug = String(a.city)
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, "-")
            .replace(/(^-|-$)/g, "")
          return (
            <li>
              <a
                href={`/service-areas/${citySlug}/${serviceSlug}/`}
                class="block rounded-2xl border border-ps-muted bg-white px-4 py-3 text-ps-navy hover:border-ps-red/60 hover:text-ps-red"
              >
                <div class="text-sm font-semibold">{a.city}</div>
                {a.state && (
                  <div class="text-[11px] text-ps-navy/70">{a.state}</div>
                )}
              </a>
            </li>
          )
        })}
      </ul>
    </section>

    <section class="mt-10">
      <TrustGrid />
    </section>

    <section class="mt-10">
      <ProcessStrip />
    </section>
  </main>
</SiteLayout>
